name: E2E+API

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  api:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: Install dependencies
        run: npm ci

      - name: Run API tests
        run: |
          mkdir -p allure-results
          npx playwright test --grep "@api"
        continue-on-error: true

      - name: Upload API results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-results-api
          path: allure-results/
          if-no-files-found: warn

  e2eTest:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Create allure-results directory
        run: mkdir -p allure-results

      - name: Run E2E tests
        run: npx playwright test --grep "@PO"
        continue-on-error: true

      - name: Upload E2E results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-results-e2e
          path: allure-results/
          if-no-files-found: warn

      - name: Deploy report
        if: always()
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: allure-history  # default: gh-pages

      # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram
      - name: üì¢ Notify in Telegram
        if: always()
        run: |
          status=${{ job.status }}
          if [ "$status" = "success" ]; then
            emoji="‚úÖ"
            text="–¢–ï–°–¢–´ –ü–†–û–ô–î–ï–ù–´"
          else
            emoji="‚ùå"
            text="–û–®–ò–ë–ö–ò –í –¢–ï–°–¢–ê–•"
          fi
            msg="$emoji *$text* $emoji%0A"
            msg+="%0Aüìä *–†–µ–∑—É–ª—å—Ç–∞—Ç—ã*:%0A"
                           
            msg+="üìã –í—Å–µ–≥–æ: *$TOTAL*%0A"
            msg+="‚úÖ –ü—Ä–æ–π–¥–µ–Ω–æ: *$PASSED*%0A"
            msg+="‚ùå –£–ø–∞–ª–∏: *$FAILED*%0A"
            msg+="‚è≠Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–æ: *$SKIPPED*%0A"
            msg+="%0A‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ%0A"
            msg+="üîó [–û—Ç—á—ë—Ç Allure](https://github.com/MaryIvova/Diploma/)%0A"
            msg+="üß™ [TestOps](https://allure.autotests.cloud/project/4993)%0A"
            msg+="üì¶ [–ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã]($GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID)%0A"
            msg+="%0Aüè∑Ô∏è *–ó–∞–ø—É—Å–∫ #${{ github.run_number }}*"
                           
            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d parse_mode=Markdown \
            -d text="$msg"